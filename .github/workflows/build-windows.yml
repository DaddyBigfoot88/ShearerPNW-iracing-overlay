- name: Setup Node 20 (LTS)
  uses: actions/setup-node@v4
  with:
    node-version: '20'

- name: Configure npm
  shell: pwsh
  run: |
    npm config set fund false
    npm config set audit false
    npm config set progress false
    npm config set cache C:\npm\cache
    $env:NPM_CONFIG_LOGLEVEL = "verbose"

- name: Install deps (no scripts, no optional)
  shell: pwsh
  run: |
    npm install --no-audit --no-fund --ignore-scripts --omit=optional --loglevel=verbose

- name: Dump npm debug log (on failure)
  if: failure()
  shell: pwsh
  run: |
    $log = Get-ChildItem -Recurse C:\npm\cache\_logs\*-debug-0.log |
      Sort-Object LastWriteTime -Descending | Select-Object -First 1
    if ($log) {
      "NPM LOG FILE: $($log.FullName)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
      Get-Content $log.FullName -Raw | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
    } else {
      "No npm log found in C:\npm\cache\_logs" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
    }

- name: Build renderer
  run: npm run build:ui

- name: Package Windows app (portable .exe)
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: npx electron-builder --win portable

- name: Upload artifact
  uses: actions/upload-artifact@v4
  with:
    name: iracing-overlay-windows
    path: release/**
